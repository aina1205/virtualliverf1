<script>

  function show_ajax_loader() {
    $('assay_list_collection').innerHTML=<%= "'"+image_tag("ajax-loader.gif")+"'" -%> ;
  }

</script>
<%= f.error_messages %>

<p>
  <%= f.label :title %>
  <%= f.text_field :title %>
</p>

<p>
  <%= f.label :description %>
  <%= f.text_area :description %>
</p>

<p>
  <%= f.label :experiment_type %>
  <%= f.collection_select :experiment_type_id,ExperimentType.find(:all),:id,:title %>
</p>

<p>
  <%= f.label :topic %>
  <% topic_value=@experiment.assay ? @experiment.assay.topic.id : 0 %>
  <%= select_tag "topic_id",
    options_for_select([["Select topic..",0]]|Topic.find(:all).collect {|t| [t.title,t.id]},topic_value),
    {:onchange=>remote_function(
      :update=>:assay_list_collection,
      :url=>{:action=>"topic_selected_ajax"},
      :with=>"'topic_id='+this.value",
      :before=>"show_ajax_loader()"
    )
  }
  -%>
</p>

<div id="assay_list_collection">
  <% if @experiment.assay -%>
    <%= render :partial=>"experiments/assay_list",:locals=>{:topic=>@experiment.assay.topic,:selected=>@experiment.assay.id} %>
  <% end -%>
</div>
<script>


  function copy_selected_sop() {
    selected_option_index=$("possible_sops").selectedIndex
    selected_option=$("possible_sops").options[selected_option_index]
    target_select=$("experiment_sop_ids")
    target_select[target_select.length]=selected_option
  }

</script>


<div id="sop_list_collection">
  <%= f.label :sops %>
  <%= select_tag :possible_sops,options_for_select( authorised_sops.collect{|s| [s.title,s.id]} ) %>
</div>

<div id="collected_sops">
  <%= f.label :sops %>
  <%= f.collection_select :sop_ids,@experiment.sops,:id,:title,{},:multiple=>true %>
</div>

<%= link_to_function ">>>","copy_selected_sop();" %>
<p style="margin-top: 2em; text-align: center;">
  <%= f.submit(action==:edit ? "Update" : "Create") -%>
  or <%= link_to 'Cancel', (@experiment.id ? experiment_path(@experiment.id) : experiments_path) -%>
</p>

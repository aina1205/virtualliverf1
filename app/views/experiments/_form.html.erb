<%= javascript_include_tag "experiments.js" %>

<script type="text/javascript">
  function show_ajax_loader(element) {
    $(element).innerHTML=<%= "'"+image_tag("ajax-loader.gif")+"'" -%> ;
  }  

</script>
<%= error_messages_for :experiment %>


<center>
  <div style="width: 60%;">

    <p style="margin-top: 1.5em;">
      <%= f.label "Title *" %><br/>
      <%= f.text_field :title,:style=>"width: 100%;" %>
    </p>

    <p style="margin-top: 0.5em;">
      <%= f.label :description %><br/>
      <%= f.text_area :description,:style => "width: 100%;", :rows => 5 %>
    </p>

    <p>
      <%= f.label "Experimentalist(s)" %>
      <%= f.text_field :experimentalist,:style=>"width: 100%;" %>
    </p>


  </div>
</center>


<br/>

<div class="fold">
  <div class="foldTitle">
    Experiment details
  </div>
  <div class="foldContent">

    <p>
      <%= f.label :project %><br/>
      <%
      selected_project=0
      selected_project=project_from_assay(@experiment.assay) if @experiment.assay
    %>
      <%=
      select_tag :project_id,
        options_for_select([["Select project ..",0]]|current_user.person.projects.collect{|p| [h(p.name),p.id]},selected_project),
        {:onchange=>remote_function(
          :url=>{:action=>"project_selected_ajax"},
          :with=>"'project_id='+this.value",
          :before=>"show_ajax_loader('topic_collection');show_ajax_loader('assay_list_collection')"
        ),:style=>"width:82%"

      }
    %>
    </p>

    <p>
      <%= f.label :topic %><br/>
      <span id="topic_collection">
        <% if @experiment.assay -%>
          <%= render :partial=>"experiments/topic_list",:locals=>{:topics=>topics_from_assay(@experiment.assay)} %>
        <% else -%>
          <%= render :partial=>"experiments/topic_list",:locals=>{:topics=>[]} %>
        <% end -%>
      </span>
      <br/>
    </p>
    <p>
      <%= label_tag "Assay *" %><br/>
      <span id="assay_list_collection">

        <% if @experiment.assay -%>
          <%= render :partial=>"experiments/assay_list",:locals=>{:topic=>@experiment.assay.topic,:selected=>@experiment.assay.id} %>
        <% else %>
          <%= render :partial=>"experiments/assay_list",:locals=>{:topic=>nil,:selected=>nil} %>
        <% end -%>

      </span>
    </p>

    <p>
      <%= f.label :experiment_type %><br/>
      <%= f.collection_select :experiment_type_id,ExperimentType.find(:all),:id,:title,{},{:style=>"width:82%"} %>
    </p>

  </div>
</div>


<div class="fold">

  <div class="foldTitle">Sops</div>
  <div class="foldContent">
    
    <br/>
    <p style="color: #666666;">
      The following Sops are used as part of this experiment:
    </p>
    <p id="sop_to_list" class="box_editing_inner" style="line-height: 1.5;">
      <span class="none_text" id="sops">Loading...</span>
    </p>
    <%= f.collection_select :sop_ids,[],:id,:title,{},:multiple=>true,:style=>"display:none;" %>
    <br/>
    <div id="sop_list_collection">
      <%= f.label :available_sops %><br/>
      <%= select_tag :possible_sops,options_for_select( authorised_sops.collect{|s| [s.title,s.id]} ),:style => "width: 82%;" %>
      <b><%= link_to_function "Add","addSelectedSop(); return(false);" %></b>
    </div>
    
  </div>
</div>

<script type="text/javascript">

<% @experiment.sops.each do |s| -%>
    sop_id = <%= s.id -%>;
    sop_title = '<%= s.title -%>';
    addSop(sop_title,sop_id);
<% end -%>

   updateSops();
</script>










<p style="margin-top: 2em; text-align: center;">
  <%= f.submit(action==:edit ? "Update" : "Create") -%>
  or <%= link_to 'Cancel', (@experiment.id ? experiment_path(@experiment.id) : experiments_path) -%>
</p>

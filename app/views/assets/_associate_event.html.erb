<% resource_text ||= resource.class.name.downcase %>
<div class="fold">

  <div class="foldTitle">
    <%= help_icon("Here you associate even in SEEK to this #{resource_text}.") -%>
    Associate Event
  </div>

  <div id="associate_event_fold_content" class="foldContent" style="display: block;">
    <div class="yui-u first" style="width:66%; float:left">
      
      <%
        all_events=authorised_events.sort{|a, b| a.title<=>b.title}
        project_events=all_events.select{|df| current_user.person.projects.include?(df.project )}
        select_truncate_length=120
      -%>
      
      <p style="color: #666666;">
        The following Events are involved in this <%= resource_text -%>:
      </p>
      <div id="event_to_list" class="box_editing_inner" style="line-height: 1.5">
        <span class="none_text" id="event_files">Loading...</span>
      </div>
      <div class="association_step">  
        <%= select_tag :possible_events,
          options_for_select([["Select Event ...",0]]|project_events.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}),
          {:style=>"width:90%",:onchange=>remote_function(
            :url=>{:action=>"preview",:controller=>"events",:element=>"event_preview"},
            :with=>"'id='+this.value",
            :before=>"show_ajax_loader('event_preview')"
          )+";check_show_add_event();return(false);"
        } -%>
        
        <%= select_tag :event_ids,'',{:multiple=>true,:style=>"display:none;"} -%>
        
        <br/>

        <%= check_box_tag :include_other_project_events, nil, false, {:onchange=>"toggle_event_list();",:style=>"margin-top:0.5em;"} -%> Include Events from other projects?
      </div>
	  <br/>
      <%= link_to_function (image("new") + " Include in the #{resource_text}"), "addSelectedEvent(); return(false);", :id=>"add_event_link", :class=>"block_link", :style => "width: 11em" %>
    </div>
  
    <div id="event_preview" class="yui-u preview_box"  style="float:right">
      <div style="text-align: center;">Event preview</div>
    </div>
 
    <br style="clear:both"/>
  
  </div>
</div>
  

<script type="text/javascript">
    var events_array = new Array();
    function toggle_event_list() {
        var checked = $('include_other_project_events').checked;
        var selection_box = $('possible_events');
        var option;

        selection_box.options.length = 0;

        if (checked) {
        <% ([["Select Event ...",0]]|all_events.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}).each do |df_details| -%>
            option = document.createElement("OPTION");
            option.text = '<%= escape_javascript(df_details[0]) -%>';
            option.value = '<%= df_details[1] -%>';
            try {
                selection_box.add(option); //for older IE version
            }
            catch (ex) {
                selection_box.add(option, null);
            }
        <% end -%>
        }
        else {
        <% ([["Select Event ...",0]]|project_events.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}).each do |df_details| -%>
            option = document.createElement("OPTION");
            option.text = '<%= escape_javascript(df_details[0]) -%>';
            option.value = '<%= df_details[1] -%>';
            try {
                selection_box.add(option); //for older IE version
            }
            catch (ex) {
                selection_box.add(option, null);
            }
        <% end -%>
        }
        selection_box.selectedIndex = 0;
        selection_box.onchange();
    }

<% if params[:event_ids] %>
  <% params[:event_ids].each do |id_and_rel_id| -%>
    <% event = Event.find(a_id) %>
    <% if Authorization.is_authorized?("show",nil,event,current_user) -%>
        event_id = '<%= event.id -%>';
        event_title = '<%= escape_javascript(event.title) -%>';
        events_array.push([event_title, event_id]);
    <% end -%>
  <% end -%>
<% end -%>

//  updateEventFiles();

  function check_show_add_event() {
  i=$('possible_events').selectedIndex;
    selected_id=$('possible_events').options[i].value;
    if (selected_id=='0') {
      $('add_event_link').hide();
    }
    else {
      $('add_event_link').show();
    }
  }

  check_show_add_event();
  function addSelectedEvent() {
    selected_option_index=$("possible_events").selectedIndex;
    selected_option=$("possible_events").options[selected_option_index];
    title=selected_option.text;
    id=selected_option.value;

    if(checkNotInList(id,events_array)) {
        events_array.push([title,id]);
        updateEvents();
    }
    else {
        alert('The following Event had already been added:\n\n' +
            title);
    }
}



function updateEvents() {
    event_text='<ul class="related_asset_list">'
    for (var i=0;i<events_array.length;i++) {
        event=events_array[i];
        title=event[0];
        id=event[1];
        titleText = '<span title="' + title + '">' + title.truncate(100) + '</span>';
        event_text += '<li>' + titleText +
        '&nbsp;&nbsp;&nbsp;<small style="vertical-align: middle;">'
        + '[<a href="" onclick="javascript:events_array.splice('+i+', 1);updateEvents(); return(false);">remove</a>]</small></li>';
    }

    event_text += '</ul>';

    // update the page
    if(events_array.length == 0) {
        $('event_to_list').innerHTML = '<span class="none_text">No data files</span>';
    }
    else {
        $('event_to_list').innerHTML = event_text;
    }

    clearList('event_ids');

    select=$('event_ids');
    for (i=0;i<events_array.length;i++) {
        id=events_array[i][1];
        o=document.createElement('option');
        o.value=id;
        o.text=id;
        o.selected=true;
        try {
            select.add(o); //for older IE version
        }
        catch (ex) {
            select.add(o,null);
        }
    }
}
</script>

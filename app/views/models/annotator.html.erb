<%= javascript_include_tag "jws/JWSconstructor_panels.js","jws/webMathematica.js","jws/addEvent.js","jws/sweetTitles.js","jws/Resizeable_Textbox/javascript.js","jws/Resizeable_Container/javascript.js","jws/jws_builder.js" -%>

<%= stylesheet_link_tag 'jws/JWSconstructor_panels','jws/Resizeable_Textbox/style.css','jws/Resizeable_Container/style.css','jws/jws_builder' -%>
<style>
    .builder_box {
        width: 50em;
        padding: 3px;
        float: left;
    }
</style>


<h1>
  Annotator
</h1>

<script type="text/javascript">
  var annotations = new Array();
  var cached_annotations = new Array();
  var search_results = new Array();

  function submit_annotations() {
      update_annotation_field("annotationsSpecies","species",annotations);
      update_annotation_field("annotationsReactions","reactions",annotations);
      $('form').submit();
  }

  function submit_search(prefix) {
      $('form').following_action.value = "annotate";

      if (prefix == "species") {
          $('reactions_search_box').value="";
          $('reactions_selected_symbol').value="";
          $('nameToSearch').value=$('species_search_box').value;
      }

      if (prefix == "reactions") {
          $('species_search_box').value="";
          $('species_selected_symbol').value="";
          $('nameToSearch').value=$('reactions_search_box').value;
      }

      submit_annotations();
  }

  function draw_cached_annotation_table(prefix,key,triplets) {
      parent_element = $(prefix+"_cached_annotations");
      table_id=encodeURI(key)+"_table";
      table = "<table id='"+table_id+"' style='display:none;'>"
      for (var i=0;i<triplets.length;i++) {
          trip = triplets[i];
              row = "<tr><td>"+trip.urn+"</td><td>" + trip.full_name +"</td>";
              js="javascript:add_cached_annotation('"+prefix+"','"+key+"',"+i+");";

              row = row + "<td><a href=\""+js+"\">Add</a></td></tr>";
              table=table+row;
      }
      parent_element.innerHTML=parent_element.innerHTML+table;
  }

  function draw_assigned_annotation_table(prefix,key) {
      if (annotations[prefix]!=undefined && annotations[prefix][key] != undefined) {
          triplets = annotations[prefix][key];
          table="<table>";
          for (var i=0;i<triplets.length;i++) {
              trip = triplets[i];
              row = "<tr><td>"+trip.urn+"</td><td>" + trip.full_name +"</td>";
              js="javascript:drop_annotation('"+prefix+"','"+key+"',"+i+");"
              row = row + "<td><a href=\""+js+"\">Drop</a></td></tr>";
              table=table+row;
          }
          table=table+"</table>";
          $(prefix+"_assigned_annotations").innerHTML = table;
      }
  }

  function drop_annotation(prefix,key,index) {
      if (annotations[prefix]!=undefined && annotations[prefix][key] != undefined) {
        annotations[prefix][key].splice(index,1);
        draw_assigned_annotation_table(prefix,key);
      }      
  }

  function store_annotations(prefix,key,triplets) {
      if (annotations[prefix] == undefined) {
          annotations[prefix] = new Array();
      }
      annotations[prefix][key] = triplets;
  }

  function store_cached_annotations(prefix,key,triplets) {
      if (cached_annotations[prefix] == undefined) {
          cached_annotations[prefix] = new Array();
      }
      cached_annotations[prefix][key] = triplets;
  }

  function store_search_results(triplets) {
      search_results = triplets;
  }

  function display_cached_annotation_table(prefix,key) {
      hide_all_cached_annotation_tables(prefix);
      table_id=encodeURI(key)+"_table";
      el=$(table_id);
      if (el != undefined) {
        el.style.display="block";
      }
  }

  function hide_all_cached_annotation_tables(prefix) {
      for (var k in cached_annotations[prefix]) {
          table_id=encodeURI(k)+"_table";
          el=$(table_id);
          if (el != undefined) {
            el.style.display="none";
          }
      }
  }

  function add_search_result(prefix,key,index) {
      if (annotations[prefix] == undefined) {
          annotations[prefix]=new Array();
      }
      if (annotations[prefix][key] == undefined) {
          annotations[prefix][key] = new Array();
      }
      triplet = search_results[index];
      annotations[prefix][key].push(triplet);
      draw_assigned_annotation_table(prefix,key);
  }

  function add_cached_annotation(prefix,key,index) {
      if (annotations[prefix] == undefined) {
          annotations[prefix]=new Array();
      }
      if (annotations[prefix][key] == undefined) {
          annotations[prefix][key] = new Array();
      }
      triplet = cached_annotations[prefix][key][index];
      annotations[prefix][key].push(triplet);
      draw_assigned_annotation_table(prefix,key);
  }

  function display_search_results(prefix,key,search_term,triplets) {
      annotation_selected(prefix,key);
      hide_all_cached_annotation_tables(prefix);
      parent_element = $(prefix+"_search_results");
      table_id=encodeURI(key)+"_table";
      table = "<table>"
      for (var i=0;i<triplets.length;i++) {
          trip = triplets[i];
              row = "<tr><td>"+trip.urn+"</td><td>" + trip.full_name +"</td>";
              js="javascript:add_search_result('"+prefix+"','"+key+"',"+i+");";

              row = row + "<td><a href=\""+js+"\">Add</a></td></tr>";
              table=table+row;
      }
      $(prefix+"_search_box").value=search_term;
      parent_element.innerHTML=table;
      parent_element.style.display = "block";
  }

  function hide_search_results(prefix) {
      parent_element = $(prefix+"_search_results");
      parent_element.style.display="none";

  }

  function annotation_selected(prefix,key) {
    draw_assigned_annotation_table(prefix,key);
    hide_search_results(prefix);
    display_cached_annotation_table(prefix,key);
    $(prefix+'_selected_annotation').innerHTML = key;
    $(prefix+'_search_box').value = key;
    $(prefix+'_selected_symbol').value = key;
  }



  function update_annotation_field(element_id,prefix,annotations) {
      text=""
      for (var key in annotations[prefix]) {
          triplets=annotations[prefix][key]
          for (var i=0;i<triplets.length;i++) {
              if (triplets[i]!=undefined) {
                text=text+key+" "+triplets[i].urn+" "+triplets[i].full_name+"\n"
              }
          }
      }
      $(element_id).value=text;
  }
</script>

<% if @search_results  -%>
    Search Term: <%= @search_results.search_term -%><br/>
    Selected Symbol = <%= @search_results.selected_symbol -%><br/>
    Results size = <%= @search_results.results.size -%><br/>
    Error code = <%= @search_results.error_code -%><br/>
    Search Status = <%= @search_results.search_status -%><br/>
<% end -%>

<input type="Button" value="Submit" onclick="submit_annotations();">

<% form_tag submit_to_jws_model_path(@model,:version=>@display_model.version),:name=>"form",:id=>"form" do -%>
        <%= jws_annotator_hidden_fields @params_hash -%>
        <%= hidden_field_tag :following_action, "" -%>
        <%= hidden_field_tag :nameToSearch, "" -%>


<%= render :partial=>"models/builder/annotation_box",:locals=>{:prefix=>"species",:title=>"Annotations for species",:type=>"species",:cached_annotations=>@cached_annotations, :annotation_hash=>@species_annotations} -%>

<%= render :partial=>"models/builder/annotation_box",:locals=>{:prefix=>"reactions",:title=>"Annotations for processes",:type=>"reactions", :annotation_hash=>@reaction_annotations} -%>

<% end -%>
<script type="text/javascript">
<% if @search_results -%>
<%
   prefix = @species_annotations.keys.include?(@search_results.selected_symbol) ? "species" : "reactions"
-%>
   triplets = new Array();
    <% @search_results.results.each do |triplet| -%>
        triplet = {"urn" : '<%= triplet.urn -%>',"full_name" : '<%= escape_javascript(triplet.full_name) -%>' , "qualifier" : '<%= triplet.qualifier -%>' };
        triplets.push(triplet);
    <% end -%>
    store_search_results(triplets);
    display_search_results('<%= prefix -%>','<%= @search_results.selected_symbol -%>','<%= @search_results.search_term -%>',triplets);

<% end -%>
</script>
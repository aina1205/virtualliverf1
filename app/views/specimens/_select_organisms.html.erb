<%
  select_truncate_length=120
  all_organisms = Organism.find(:all,:order=>:title)
  culture_growth_options=options_for_select(CultureGrowthType.find(:all,:order=>:title).collect{|cg| [cg.title,cg.id]}.insert(0,"Not specified"))
-%>
<div class="fold">

  <div class="foldTitle">
    <%= help_icon("Here you can associate the specimen with specific organism and strain.") -%>
    Organism <span class="required">*</span>
  </div>

  <div id="organisms_fold_content" class="foldContent" style="display: block;">
    <div class="yui-u first">
      <p style="color: #666666;">
        The following Organism and strain is involved in this Specimen:
      </p>
      <div id="organism_to_list" class="box_editing_inner" style="line-height: 1.5;">
        <span class="none_text" id="organisms">Loading...</span>
      </div>
      <div class="association_step">
        <b>Step 1</b> - Choose an organism<br/><br/>
        <%= select_tag :possible_organisms,
        options_for_select([["Select Organism ...", 0]]|all_organisms.collect{|o| [truncate(h(o.title), :length=>select_truncate_length), o.id]}),
         {:style=>"width:90%",
          :onchange=>remote_function(:url=>{:action=>"show_existing_strains", :controller=>"strains",:element=>"existing_strains"},
          :with=>"'organism_id='+this.value",
          :before=>"show_ajax_loader('existing_strains')")+
          ";check_show_add_organism();$('strain').clear();return(false);"} -%>
        <%= select_tag :specimen_organism_id, options_from_collection_for_select([], :id, :title), {:style=>"display:none;"} -%>
      </div>
      <div id="extra_organism_details" style="display:none;">
        <div class="association_step">
          <b>Step 2</b> - Select method of culture growth (optional)<br/><br/>
          <%= select_tag :culture_growth,culture_growth_options -%>
          <br/>
        </div>
        <div class="association_step">
          <b>Step 3</b> - Specify a strain (optional)<br/>
          <div id="existing_strains"></div>
          <%= text_field_tag :strain %>
          <br/>
        </div>
		<br/>
        <%= link_to_function (image("new") + " Include in the Specimen"), "addSelectedOrganism(); return(false);", :id=>"add_organism_link", :class=>"block_link", :style => "width: 12em" %>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
 var organism = new Array();
  function setStrainTextField(strain){
      $('strain').value = strain;
      new Effect.Highlight('strain');
  }


      organism_id = '<%= @specimen.organism.id unless @specimen.organism.nil? -%>';
      organism_title = '<%= escape_javascript(@specimen.organism.title) unless @specimen.organism.nil?-%>';
      strain = '<%= @specimen.strain.nil? ? "" :@specimen.strain.title unless @specimen.strain.nil?-%>';
      culture_growth = '<%= @specimen.culture_growth_type.nil? ? "" : @specimen.culture_growth_type.title unless @specimen.culture_growth_type.nil?-%>'  ;
       if((organism_title+strain+culture_growth)!=""){
           addOrganism(organism_title, organism_id, strain, culture_growth);
       }
  <% if params[:specimen_organism_id] %>
    <% text = params[:specimen_organism_id] -%>
      <%
      o_id,strain,culture_growth_type_text=text.split(",")
      organism=Organism.find(o_id)
      %>
        organism_id = '<%= o_id -%>';
        organism_title = '<%= escape_javascript(organism.title) -%>';
        strain = '<%= strain -%>';
        culture_growth = '<%= culture_growth_type_text -%>';
        addOrganism(organism_title, organism_id,strain,culture_growth);
  <% end -%>

 function checkOrganismNotInList(title,id,strain,culture_growth) {
       toAdd = true;
     if(organism.length > 0) {
           if(organism[0][0] == title && organism[0][1] == id && organism[0][2] && organism[0][3]) {
                toAdd = false;
            }
     }
      return toAdd;
    }
  function addOrganism(title,id,strain,culture_growth) {
      if (checkOrganismNotInList(title,id,strain,culture_growth)) {
      organism.push([title,id,strain,culture_growth]);

      updateOrganisms();
      }

}


function addSelectedOrganism() {
    selected_option_index=$("possible_organisms").selectedIndex;
    selected_option=$("possible_organisms").options[selected_option_index];
    title=selected_option.text;
    id=selected_option.value;
    strain=$('strain').value

    selected_option_index=$('culture_growth').selectedIndex;
    selected_option=$('culture_growth').options[selected_option_index];
    culture_growth=selected_option.text;

    if(organism.length > 0) {
        removeOrganism(0);
    }
    addOrganism(title,id,strain,culture_growth);
}

function removeOrganism(index) {
    // remove according to the index
    organism.splice(index, 1);
    // update the page
    updateOrganisms();
}

function updateOrganisms() {
    organism_text='<ul class="related_asset_list">';
  if(organism.length >0) {
    o = organism[0];
    title=o[0];
    id=o[1];
    strain=o[2];
    culture_growth=o[3];

        titleText = '<span title="' + title + '">' + title.truncate(100);
        if (strain.length>0) {
            titleText += ":"+strain
        }
        if (culture_growth.length>0 && culture_growth!='Not specified') {
            titleText += " <span class='assay_item_sup_info'>("+culture_growth+")</span>";
        }
        titleText +=  '</span>';
        organism_text += '<li>' + titleText +
          '&nbsp;&nbsp;&nbsp;<small style="vertical-align: middle;">' +
          '[<a href=\"\" onclick=\"javascript:removeOrganism('+0+'); return(false);\">remove</a>]</small></li>';

  }
    organism_text += '</ul>';

    // update the page
    if(organism.length == 0) {
        $('organism_to_list').innerHTML = '<span class="none_text">No organism</span>';
    }
    else {
        $('organism_to_list').innerHTML = organism_text;
    }

    clearList('specimen_organism_id');

    select=$('specimen_organism_id');
     if(organism.length >0) {
        or = organism[0];
        id = or[1];
        strain = or[2];
        culture_growth = or[3];
        o=document.createElement('option');
        o.value=id;
        o.text=id;
        o.selected=true;
        o.value=id + "," + strain + "," + culture_growth;
        try {
            select.add(o); //for older IE version
        }
        catch (ex) {
            select.add(o,null);
        }
     }
}
    updateOrganisms();

    function check_show_add_organism() {
      i = $('possible_organisms').selectedIndex;
      selected_id = $('possible_organisms').options[i].value;
      if (selected_id == '0') {
        Effect.Fade('extra_organism_details');
      }
      else {
        Effect.Appear('extra_organism_details');
      }
    }

    check_show_add_organism();

</script>

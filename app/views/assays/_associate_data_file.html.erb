<%
all_data_files=authorised_data_files.sort{|a, b| a.title<=>b.title}
project_data_files=all_data_files.select{|df| current_user.person.projects.include?(df.project )}
select_truncate_length=120;
-%>

<script type="text/javascript">
  function toggle_data_file_list() {
    var checked = $('include_other_project_data_files').checked;
    var selection_box = $('possible_data_files');
    var option;
            
    selection_box.options.length=0;

    if (checked) {
<% ([["Select Data file ...",0]]|all_data_files.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}).each do |df_details| -%>
        option = document.createElement("OPTION");
        option.text = '<%= escape_javascript(df_details[0]) -%>';
        option.value = '<%= df_details[1] -%>';
        try {
          selection_box.add(option); //for older IE version
        }
        catch (ex) {
          selection_box.add(option, null);
        }
<% end -%>
    }
    else {
<% ([["Select Data file ...",0]]|project_data_files.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}).each do |df_details| -%>
        option = document.createElement("OPTION");
        option.text = '<%= escape_javascript(df_details[0]) -%>';
        option.value = '<%= df_details[1] -%>';
        try {
          selection_box.add(option); //for older IE version
        }
        catch (ex) {
          selection_box.add(option, null);
        }
<% end -%>
    }
    selection_box.selectedIndex=0;
    selection_box.onchange();
  }
</script>


<div class="yui-gc">
  <h2>Data files</h2>
  <div class="yui-u first">
    <p style="color: #666666;">
      The following Data Files are involved in this <%= @assay_text -%>:
    </p>
    <div id="data_file_to_list" class="box_editing_inner" style="line-height: 1.5">
      <span class="none_text" id="data_files">Loading...</span>
    </div>
    <br/>

    <%= label_tag :data_files %><br/>

    <%= select_tag :possible_data_files,
      options_for_select([["Select Data file ...",0]]|project_data_files.collect{|s| [truncate(h(s.title),:length=>select_truncate_length),s.id]}),
      {:style=>"width:90%",:onchange=>remote_function(
        :url=>{:action=>"preview",:controller=>"data_files",:element=>"data_file_preview"},
        :with=>"'id='+this.value",
        :before=>"show_ajax_loader('data_file_preview')"
      )+";check_show_add_data_file();return(false);"
    } -%>
    <%= select_tag :assay_data_file_ids,'',{:multiple=>true,:style=>"display:none;"} -%>
    <% if show_relationships -%>
      <br/>
      <%= label_tag "Relationship between the data and the model" %><br/>
      <%= select_tag :data_file_relationship_type, options_for_select([["None",0]] + RelationshipType.all.collect{|r| [r.title,r.id]}) %>
    <% end -%>
    <b><%= link_to_function "Add","addSelectedDataFile(); return(false);",:id=>"add_data_file_link" %></b>
    <br/>
    <%= check_box_tag :include_other_project_data_files, nil, false, {:onchange=>"toggle_data_file_list();",:style=>"margin-top:0.5em;"} -%> Include Data files from other projects?
  </div>

  <div id="data_file_preview" class="yui-u">
    <div style="text-align: center;">Data file preview</div>
  </div>

</div>

<script type="text/javascript">

<% @assay.data_file_masters.each do |data_file| -%>    
  <% if Authorization.is_authorized?("show",nil,data_file,current_user) -%>
      data_file_id = '<%= data_file.id -%>';
      data_title = '<%= escape_javascript(data_file.title) -%>';
      relationship_type = '<%= escape_javascript(data_file.relationship_type(@assay).try(:title) || "None") -%>';
      addDataFile(data_title,data_file_id,relationship_type);
  <% end -%>
<% end -%>

<% if params[:assay_data_file_ids] %>
  <% params[:assay_data_file_ids].each do |id_and_rel_id| -%>
    <% a_id, r_type = id_and_rel_id.split(",") %>
    <% data_file = DataFile.find(a_id) %>
    <% if Authorization.is_authorized?("show",nil,data_file,current_user) -%>
        data_file_id = '<%= data_file.id -%>';
        data_title = '<%= escape_javascript(data_file.title) -%>';
        relationship_type = '<%= r_type -%>';
        addDataFile(data_title, data_file_id, relationship_type);
    <% end -%>
  <% end -%>
<% end -%>

  updateDataFiles();

  function check_show_add_data_file() {
    i=$('possible_data_files').selectedIndex;
    selected_id=$('possible_data_files').options[i].value;
    if (selected_id=='0') {
      $('add_data_file_link').hide();
    }
    else {
      $('add_data_file_link').show();
    }
  }

  check_show_add_data_file();
</script>
